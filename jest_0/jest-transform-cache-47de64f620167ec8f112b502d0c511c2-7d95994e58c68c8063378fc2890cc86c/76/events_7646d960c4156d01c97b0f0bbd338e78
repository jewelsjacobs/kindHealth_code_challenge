26dbcebdfdfeaa744e123330d5da29a0
/* eslint-disable no-irregular-whitespace */
const Event = require('../models').event;

const Sequelize = require('sequelize');

let db = require('../models/index');

const Op = Sequelize.Op;

const _ = require('lodash');

const rawSQLQueury = `select date_trunc(?, "date") as "date", \
case when type = 'comment' then count(type) end as "comments", \
case when type = 'leave' then count(type) end as "leaves", \
case when type = 'highfive' then count(type) end as "highfives", \
case when type = 'enter' then count(type) end as "enters" \
from \
public.${process.env.POSTGRES_DB} \
where \
type is not null \
and "date" > date_trunc(?, \
timestamp ?) \
and "date" < date_trunc(?, \
timestamp ?) \
group by "date", "type";`;
module.exports = {
  create(req, res) {
    const {
      user,
      type,
      message = null,
      otheruser = null,
      date
    } = req.body;
    return Event.create({
      user,
      type,
      message,
      otheruser,
      date
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  },

  list(req, res) {
    return Event.findAll({
      where: {
        date: {
          [Op.lt]: req.query.to,
          [Op.gt]: req.query.from
        }
      }
    }).then(results => {
      const response = {
        events: []
      };

      const transformedResults = _.map(results, result => {
        const filteredEvent = {};
        filteredEvent.id = result.id;
        filteredEvent.date = result.date;
        filteredEvent.user = result.user;
        filteredEvent.type = result.type;

        if (result.message !== null) {
          filteredEvent.message = result.message;
        }

        if (result.otheruser !== null) {
          filteredEvent.otheruser = result.otheruser;
        }

        return filteredEvent;
      });

      response.events = transformedResults;
      res.status(200).json(response);
    }).catch(error => res.status(400).send(error));
  },

  summary(req, res) {
    return db.sequelize.query(rawSQLQueury, {
      replacements: [req.query.by, req.query.by, req.query.from, req.query.by, req.query.to],
      type: db.sequelize.QueryTypes.SELECT
    }).then(events => {
      const results = {
        events: []
      };

      const transformedEvents = _.chain(events).map(event => {
        event.comments === null ? event.comments = 0 : event.comments;
        event.leaves === null ? event.leaves = 0 : event.leaves;
        event.highfives === null ? event.highfives = 0 : event.highfives;
        event.enters === null ? event.enters = 0 : event.enters;
        return event;
      }).reduce((result, value) => {
        return {
          "date": result.date,
          "comments": parseInt(value.comments, 10) + parseInt(result.comments, 10),
          "leaves": parseInt(value.leaves) + parseInt(result.leaves),
          "highfives": parseInt(value.highfives, 10) + parseInt(result.highfives, 10),
          "enters": parseInt(value.enters, 10) + parseInt(result.enters, 10)
        };
      }).value();

      results.events.push(transformedEvents);
      res.status(200).json(results);
    }).catch(error => res.status(400).send(error));
  },

  clear(req, res) {
    return Event.destroy({
      where: {},
      truncate: true
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy5qcyJdLCJuYW1lcyI6WyJFdmVudCIsInJlcXVpcmUiLCJldmVudCIsIlNlcXVlbGl6ZSIsImRiIiwiT3AiLCJfIiwicmF3U1FMUXVldXJ5IiwicHJvY2VzcyIsImVudiIsIlBPU1RHUkVTX0RCIiwibW9kdWxlIiwiZXhwb3J0cyIsImNyZWF0ZSIsInJlcSIsInJlcyIsInVzZXIiLCJ0eXBlIiwibWVzc2FnZSIsIm90aGVydXNlciIsImRhdGUiLCJib2R5IiwidGhlbiIsInN0YXR1cyIsImpzb24iLCJjYXRjaCIsImVycm9yIiwic2VuZCIsImxpc3QiLCJmaW5kQWxsIiwid2hlcmUiLCJsdCIsInF1ZXJ5IiwidG8iLCJndCIsImZyb20iLCJyZXN1bHRzIiwicmVzcG9uc2UiLCJldmVudHMiLCJ0cmFuc2Zvcm1lZFJlc3VsdHMiLCJtYXAiLCJyZXN1bHQiLCJmaWx0ZXJlZEV2ZW50IiwiaWQiLCJzdW1tYXJ5Iiwic2VxdWVsaXplIiwicmVwbGFjZW1lbnRzIiwiYnkiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwidHJhbnNmb3JtZWRFdmVudHMiLCJjaGFpbiIsImNvbW1lbnRzIiwibGVhdmVzIiwiaGlnaGZpdmVzIiwiZW50ZXJzIiwicmVkdWNlIiwidmFsdWUiLCJwYXJzZUludCIsInB1c2giLCJjbGVhciIsImRlc3Ryb3kiLCJ0cnVuY2F0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQVAsQ0FBcUJDLEtBQW5DOztBQUNBLE1BQU1DLFNBQVMsR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsSUFBSUcsRUFBRSxHQUFJSCxPQUFPLENBQUMsaUJBQUQsQ0FBakI7O0FBQ0EsTUFBTUksRUFBRSxHQUFHRixTQUFTLENBQUNFLEVBQXJCOztBQUNBLE1BQU1DLENBQUMsR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBRUEsTUFBTU0sWUFBWSxHQUFJOzs7Ozs7U0FNYkMsT0FB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QixNQUFBQSxLQUFLLEVBQUUsRUFEQTtBQUVQZ0MsTUFBQUEsUUFBUSxFQUFFO0FBRkgsS0FESixFQUtKeEMsSUFMSSxDQUtDLE1BQU1QLEdBQUcsQ0FBQ1EsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUNELE1BQUFBLE1BQU0sRUFBRTtBQUFULEtBQXJCLENBTFAsRUFNSkUsS0FOSSxDQU1HQyxLQUFELElBQVdYLEdBQUcsQ0FBQ1EsTUFBSixDQUFXLEdBQVgsRUFBZ0JJLElBQWhCLENBQXFCRCxLQUFyQixDQU5iLENBQVA7QUFPRDs7QUFyRmMsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1pcnJlZ3VsYXItd2hpdGVzcGFjZSAqL1xuY29uc3QgRXZlbnQgPSByZXF1aXJlKCcuLi9tb2RlbHMnKS5ldmVudDtcbmNvbnN0IFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpO1xubGV0IGRiICA9IHJlcXVpcmUoJy4uL21vZGVscy9pbmRleCcpO1xuY29uc3QgT3AgPSBTZXF1ZWxpemUuT3A7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IHJhd1NRTFF1ZXVyeSA9IGBzZWxlY3QgZGF0ZV90cnVuYyg/LCBcImRhdGVcIikgYXMgXCJkYXRlXCIsIFxcXG5jYXNlIHdoZW4gdHlwZSA9ICdjb21tZW50JyB0aGVuIGNvdW50KHR5cGUpIGVuZCBhcyBcImNvbW1lbnRzXCIsIFxcXG5jYXNlIHdoZW4gdHlwZSA9ICdsZWF2ZScgdGhlbiBjb3VudCh0eXBlKSBlbmQgYXMgXCJsZWF2ZXNcIiwgXFxcbmNhc2Ugd2hlbiB0eXBlID0gJ2hpZ2hmaXZlJyB0aGVuIGNvdW50KHR5cGUpIGVuZCBhcyBcImhpZ2hmaXZlc1wiLCBcXFxuY2FzZSB3aGVuIHR5cGUgPSAnZW50ZXInIHRoZW4gY291bnQodHlwZSkgZW5kIGFzIFwiZW50ZXJzXCIgXFxcbmZyb20gXFxcbnB1YmxpYy4ke3Byb2Nlc3MuZW52LlBPU1RHUkVTX0RCfSBcXFxud2hlcmUgXFxcbnR5cGUgaXMgbm90IG51bGwgXFxcbmFuZCBcImRhdGVcIiA+IGRhdGVfdHJ1bmMoPywgXFxcbnRpbWVzdGFtcCA/KSBcXFxuYW5kIFwiZGF0ZVwiIDwgZGF0ZV90cnVuYyg/LCBcXFxudGltZXN0YW1wID8pIFxcXG5ncm91cCBieSBcImRhdGVcIiwgXCJ0eXBlXCI7YDtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNyZWF0ZShyZXEsIHJlcykge1xuICAgIGNvbnN0IHsgdXNlciwgdHlwZSwgbWVzc2FnZSA9IG51bGwsIG90aGVydXNlciA9IG51bGwsIGRhdGUgfSA9IHJlcS5ib2R5O1xuICAgIHJldHVybiBFdmVudFxuICAgICAgLmNyZWF0ZSh7IHVzZXIsIHR5cGUsIG1lc3NhZ2UsIG90aGVydXNlciwgZGF0ZSB9KVxuICAgICAgLnRoZW4oKCkgPT4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N0YXR1czogXCJva1wifSkpXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxuXG4gIGxpc3QocmVxLCByZXMpIHtcbiAgICByZXR1cm4gRXZlbnRcbiAgICAgIC5maW5kQWxsKHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBkYXRlOiB7XG4gICAgICAgICAgICBbT3AubHRdOiByZXEucXVlcnkudG8sXG4gICAgICAgICAgICBbT3AuZ3RdOiByZXEucXVlcnkuZnJvbVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgIGV2ZW50czogW11cbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgdHJhbnNmb3JtZWRSZXN1bHRzID0gXy5tYXAocmVzdWx0cywgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbHRlcmVkRXZlbnQgPSB7fTtcbiAgICAgICAgICBmaWx0ZXJlZEV2ZW50LmlkID0gcmVzdWx0LmlkO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQuZGF0ZSA9IHJlc3VsdC5kYXRlO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQudXNlciA9IHJlc3VsdC51c2VyO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQudHlwZSA9IHJlc3VsdC50eXBlO1xuICAgICAgICAgIGlmIChyZXN1bHQubWVzc2FnZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgZmlsdGVyZWRFdmVudC5tZXNzYWdlID0gcmVzdWx0Lm1lc3NhZ2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQub3RoZXJ1c2VyICE9PSBudWxsKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZEV2ZW50Lm90aGVydXNlciA9IHJlc3VsdC5vdGhlcnVzZXI7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmaWx0ZXJlZEV2ZW50O1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzcG9uc2UuZXZlbnRzID0gdHJhbnNmb3JtZWRSZXN1bHRzO1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVzLnN0YXR1cyg0MDApLnNlbmQoZXJyb3IpKTtcbiAgfSxcblxuICBzdW1tYXJ5KHJlcSwgcmVzKSB7XG4gICAgcmV0dXJuIGRiLnNlcXVlbGl6ZS5xdWVyeShyYXdTUUxRdWV1cnksXG4gICAgICB7IHJlcGxhY2VtZW50czogW3JlcS5xdWVyeS5ieSwgcmVxLnF1ZXJ5LmJ5LCByZXEucXVlcnkuZnJvbSwgcmVxLnF1ZXJ5LmJ5LCByZXEucXVlcnkudG9dLCB0eXBlOiBkYi5zZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfVxuICAgICkudGhlbigoZXZlbnRzKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHRzID0ge1xuICAgICAgICBldmVudHM6IFtdXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0cmFuc2Zvcm1lZEV2ZW50cyA9IF9cbiAgICAgICAgLmNoYWluKGV2ZW50cylcbiAgICAgICAgLm1hcCgoZXZlbnQpID0+IHtcbiAgICAgICAgICAoZXZlbnQuY29tbWVudHMgPT09IG51bGwpID8gZXZlbnQuY29tbWVudHMgPSAwIDogZXZlbnQuY29tbWVudHM7XG4gICAgICAgICAgKGV2ZW50LmxlYXZlcyA9PT0gbnVsbCkgPyBldmVudC5sZWF2ZXMgPSAwIDogZXZlbnQubGVhdmVzO1xuICAgICAgICAgIChldmVudC5oaWdoZml2ZXMgPT09IG51bGwpID8gZXZlbnQuaGlnaGZpdmVzID0gMCA6IGV2ZW50LmhpZ2hmaXZlcztcbiAgICAgICAgICAoZXZlbnQuZW50ZXJzID09PSBudWxsKSA/IGV2ZW50LmVudGVycyA9IDAgOiBldmVudC5lbnRlcnM7XG4gICAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgICB9KVxuICAgICAgICAucmVkdWNlKChyZXN1bHQsIHZhbHVlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiZGF0ZVwiOiByZXN1bHQuZGF0ZSxcbiAgICAgICAgICAgIFwiY29tbWVudHNcIjogcGFyc2VJbnQodmFsdWUuY29tbWVudHMsIDEwKSArIHBhcnNlSW50KHJlc3VsdC5jb21tZW50cywgMTApLFxuICAgICAgICAgICAgXCJsZWF2ZXNcIjogcGFyc2VJbnQodmFsdWUubGVhdmVzKSArIHBhcnNlSW50KHJlc3VsdC5sZWF2ZXMpLFxuICAgICAgICAgICAgXCJoaWdoZml2ZXNcIjogcGFyc2VJbnQodmFsdWUuaGlnaGZpdmVzLCAxMCkgKyBwYXJzZUludChyZXN1bHQuaGlnaGZpdmVzLCAxMCksXG4gICAgICAgICAgICBcImVudGVyc1wiOiBwYXJzZUludCh2YWx1ZS5lbnRlcnMsIDEwKSArIHBhcnNlSW50KHJlc3VsdC5lbnRlcnMsIDEwKVxuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICAgIC52YWx1ZSgpO1xuXG4gICAgICByZXN1bHRzLmV2ZW50cy5wdXNoKHRyYW5zZm9ybWVkRXZlbnRzKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHJlc3VsdHMpO1xuICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxuXG4gIGNsZWFyKHJlcSwgcmVzKSB7XG4gICAgcmV0dXJuIEV2ZW50XG4gICAgICAuZGVzdHJveSh7XG4gICAgICAgIHdoZXJlOiB7fSxcbiAgICAgICAgdHJ1bmNhdGU6IHRydWVcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiByZXMuc3RhdHVzKDIwMCkuanNvbih7c3RhdHVzOiBcIm9rXCJ9KSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHJlcy5zdGF0dXMoNDAwKS5zZW5kKGVycm9yKSk7XG4gIH0sXG59O1xuIl19