468502d366a330650db4d65453459dd2
/* eslint-disable no-irregular-whitespace */
const Event = require('../models').event;

const Sequelize = require('sequelize');

let db = require('../models/index');

const Op = Sequelize.Op;

const _ = require('lodash');

const process = require('process');

const rawSQLQueury = `select date_trunc(?, "date") as "date", \
case when type = 'comment' then count(type) end as "comments", \
case when type = 'leave' then count(type) end as "leaves", \
case when type = 'highfive' then count(type) end as "highfives", \
case when type = 'enter' then count(type) end as "enters" \
from \
public.${process.env.POSTGRES_DB} \
where \
type is not null \
and "date" > date_trunc(?, \
timestamp ?) \
and "date" < date_trunc(?, \
timestamp ?) \
group by "date", "type";`;
module.exports = {
  create(req, res) {
    const {
      user,
      type,
      message = null,
      otheruser = null,
      date
    } = req.body;
    return Event.create({
      user,
      type,
      message,
      otheruser,
      date
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  },

  list(req, res) {
    return Event.findAll({
      where: {
        date: {
          [Op.lt]: req.query.to,
          [Op.gt]: req.query.from
        }
      }
    }).then(results => {
      const response = {
        events: []
      };

      const transformedResults = _.map(results, result => {
        const filteredEvent = {};
        filteredEvent.id = result.id;
        filteredEvent.date = result.date;
        filteredEvent.user = result.user;
        filteredEvent.type = result.type;

        if (result.message !== null) {
          filteredEvent.message = result.message;
        }

        if (result.otheruser !== null) {
          filteredEvent.otheruser = result.otheruser;
        }

        return filteredEvent;
      });

      response.events = transformedResults;
      res.status(200).json(response);
    }).catch(error => res.status(400).send(error));
  },

  summary(req, res) {
    return db.sequelize.query(rawSQLQueury, {
      replacements: [req.query.by, req.query.by, req.query.from, req.query.by, req.query.to],
      type: db.sequelize.QueryTypes.SELECT
    }).then(events => {
      const results = {
        events: []
      };

      const transformedEvents = _.chain(events).map(event => {
        event.comments === null ? event.comments = 0 : event.comments;
        event.leaves === null ? event.leaves = 0 : event.leaves;
        event.highfives === null ? event.highfives = 0 : event.highfives;
        event.enters === null ? event.enters = 0 : event.enters;
        return event;
      }).reduce((result, value) => {
        return {
          "date": result.date,
          "comments": parseInt(value.comments, 10) + parseInt(result.comments, 10),
          "leaves": parseInt(value.leaves) + parseInt(result.leaves),
          "highfives": parseInt(value.highfives, 10) + parseInt(result.highfives, 10),
          "enters": parseInt(value.enters, 10) + parseInt(result.enters, 10)
        };
      }).value();

      results.events.push(transformedEvents);
      res.status(200).json(results);
    }).catch(error => res.status(400).send(error));
  },

  clear(req, res) {
    return Event.destroy({
      where: {},
      truncate: true
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy5qcyJdLCJuYW1lcyI6WyJFdmVudCIsInJlcXVpcmUiLCJldmVudCIsIlNlcXVlbGl6ZSIsImRiIiwiT3AiLCJfIiwicHJvY2VzcyIsInJhd1NRTFF1ZXVyeSIsImVudiIsIlBPU1RHUkVTX0RCIiwibW9kdWxlIiwiZXhwb3J0cyIsImNyZWF0ZSIsInJlcSIsInJlcyIsInVzZXIiLCJ0eXBlIiwibWVzc2FnZSIsIm90aGVydXNlciIsImRhdGUiLCJib2R5IiwidGhlbiIsInN0YXR1cyIsImpzb24iLCJjYXRjaCIsImVycm9yIiwic2VuZCIsImxpc3QiLCJmaW5kQWxsIiwid2hlcmUiLCJsdCIsInF1ZXJ5IiwidG8iLCJndCIsImZyb20iLCJyZXN1bHRzIiwicmVzcG9uc2UiLCJldmVudHMiLCJ0cmFuc2Zvcm1lZFJlc3VsdHMiLCJtYXAiLCJyZXN1bHQiLCJmaWx0ZXJlZEV2ZW50IiwiaWQiLCJzdW1tYXJ5Iiwic2VxdWVsaXplIiwicmVwbGFjZW1lbnRzIiwiYnkiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwidHJhbnNmb3JtZWRFdmVudHMiLCJjaGFpbiIsImNvbW1lbnRzIiwibGVhdmVzIiwiaGlnaGZpdmVzIiwiZW50ZXJzIiwicmVkdWNlIiwidmFsdWUiLCJwYXJzZUludCIsInB1c2giLCJjbGVhciIsImRlc3Ryb3kiLCJ0cnVuY2F0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQVAsQ0FBcUJDLEtBQW5DOztBQUNBLE1BQU1DLFNBQVMsR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsSUFBSUcsRUFBRSxHQUFJSCxPQUFPLENBQUMsaUJBQUQsQ0FBakI7O0FBQ0EsTUFBTUksRUFBRSxHQUFHRixTQUFTLENBQUNFLEVBQXJCOztBQUNBLE1BQU1DLENBQUMsR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTU0sT0FBTyxHQUFHTixPQUFPLENBQUMsU0FB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LEVBQVc7QUFDZCxXQUFPZixLQUFLLENBQ1Q2RCxPQURJLENBQ0k7QUFDUC9CLE1BQUFBLEtBQUssRUFBRSxFQURBO0FBRVBnQyxNQUFBQSxRQUFRLEVBQUU7QUFGSCxLQURKLEVBS0p4QyxJQUxJLENBS0MsTUFBTVAsR0FBRyxDQUFDUSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFBQ0QsTUFBQUEsTUFBTSxFQUFFO0FBQVQsS0FBckIsQ0FMUCxFQU1KRSxLQU5JLENBTUdDLEtBQUQsSUFBV1gsR0FBRyxDQUFDUSxNQUFKLENBQVcsR0FBWCxFQUFnQkksSUFBaEIsQ0FBcUJELEtBQXJCLENBTmIsQ0FBUDtBQU9EOztBQXJGYyxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLWlycmVndWxhci13aGl0ZXNwYWNlICovXG5jb25zdCBFdmVudCA9IHJlcXVpcmUoJy4uL21vZGVscycpLmV2ZW50O1xuY29uc3QgU2VxdWVsaXplID0gcmVxdWlyZSgnc2VxdWVsaXplJyk7XG5sZXQgZGIgID0gcmVxdWlyZSgnLi4vbW9kZWxzL2luZGV4Jyk7XG5jb25zdCBPcCA9IFNlcXVlbGl6ZS5PcDtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IHByb2Nlc3MgPSByZXF1aXJlKCdwcm9jZXNzJyk7XG5cbmNvbnN0IHJhd1NRTFF1ZXVyeSA9IGBzZWxlY3QgZGF0ZV90cnVuYyg/LCBcImRhdGVcIikgYXMgXCJkYXRlXCIsIFxcXG5jYXNlIHdoZW4gdHlwZSA9ICdjb21tZW50JyB0aGVuIGNvdW50KHR5cGUpIGVuZCBhcyBcImNvbW1lbnRzXCIsIFxcXG5jYXNlIHdoZW4gdHlwZSA9ICdsZWF2ZScgdGhlbiBjb3VudCh0eXBlKSBlbmQgYXMgXCJsZWF2ZXNcIiwgXFxcbmNhc2Ugd2hlbiB0eXBlID0gJ2hpZ2hmaXZlJyB0aGVuIGNvdW50KHR5cGUpIGVuZCBhcyBcImhpZ2hmaXZlc1wiLCBcXFxuY2FzZSB3aGVuIHR5cGUgPSAnZW50ZXInIHRoZW4gY291bnQodHlwZSkgZW5kIGFzIFwiZW50ZXJzXCIgXFxcbmZyb20gXFxcbnB1YmxpYy4ke3Byb2Nlc3MuZW52LlBPU1RHUkVTX0RCfSBcXFxud2hlcmUgXFxcbnR5cGUgaXMgbm90IG51bGwgXFxcbmFuZCBcImRhdGVcIiA+IGRhdGVfdHJ1bmMoPywgXFxcbnRpbWVzdGFtcCA/KSBcXFxuYW5kIFwiZGF0ZVwiIDwgZGF0ZV90cnVuYyg/LCBcXFxudGltZXN0YW1wID8pIFxcXG5ncm91cCBieSBcImRhdGVcIiwgXCJ0eXBlXCI7YDtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNyZWF0ZShyZXEsIHJlcykge1xuICAgIGNvbnN0IHsgdXNlciwgdHlwZSwgbWVzc2FnZSA9IG51bGwsIG90aGVydXNlciA9IG51bGwsIGRhdGUgfSA9IHJlcS5ib2R5O1xuICAgIHJldHVybiBFdmVudFxuICAgICAgLmNyZWF0ZSh7IHVzZXIsIHR5cGUsIG1lc3NhZ2UsIG90aGVydXNlciwgZGF0ZSB9KVxuICAgICAgLnRoZW4oKCkgPT4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N0YXR1czogXCJva1wifSkpXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxuXG4gIGxpc3QocmVxLCByZXMpIHtcbiAgICByZXR1cm4gRXZlbnRcbiAgICAgIC5maW5kQWxsKHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBkYXRlOiB7XG4gICAgICAgICAgICBbT3AubHRdOiByZXEucXVlcnkudG8sXG4gICAgICAgICAgICBbT3AuZ3RdOiByZXEucXVlcnkuZnJvbVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgIGV2ZW50czogW11cbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgdHJhbnNmb3JtZWRSZXN1bHRzID0gXy5tYXAocmVzdWx0cywgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbHRlcmVkRXZlbnQgPSB7fTtcbiAgICAgICAgICBmaWx0ZXJlZEV2ZW50LmlkID0gcmVzdWx0LmlkO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQuZGF0ZSA9IHJlc3VsdC5kYXRlO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQudXNlciA9IHJlc3VsdC51c2VyO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQudHlwZSA9IHJlc3VsdC50eXBlO1xuICAgICAgICAgIGlmIChyZXN1bHQubWVzc2FnZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgZmlsdGVyZWRFdmVudC5tZXNzYWdlID0gcmVzdWx0Lm1lc3NhZ2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQub3RoZXJ1c2VyICE9PSBudWxsKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZEV2ZW50Lm90aGVydXNlciA9IHJlc3VsdC5vdGhlcnVzZXI7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmaWx0ZXJlZEV2ZW50O1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzcG9uc2UuZXZlbnRzID0gdHJhbnNmb3JtZWRSZXN1bHRzO1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVzLnN0YXR1cyg0MDApLnNlbmQoZXJyb3IpKTtcbiAgfSxcblxuICBzdW1tYXJ5KHJlcSwgcmVzKSB7XG4gICAgcmV0dXJuIGRiLnNlcXVlbGl6ZS5xdWVyeShyYXdTUUxRdWV1cnksXG4gICAgICB7IHJlcGxhY2VtZW50czogW3JlcS5xdWVyeS5ieSwgcmVxLnF1ZXJ5LmJ5LCByZXEucXVlcnkuZnJvbSwgcmVxLnF1ZXJ5LmJ5LCByZXEucXVlcnkudG9dLCB0eXBlOiBkYi5zZXF1ZWxpemUuUXVlcnlUeXBlcy5TRUxFQ1QgfVxuICAgICkudGhlbigoZXZlbnRzKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHRzID0ge1xuICAgICAgICBldmVudHM6IFtdXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB0cmFuc2Zvcm1lZEV2ZW50cyA9IF9cbiAgICAgICAgLmNoYWluKGV2ZW50cylcbiAgICAgICAgLm1hcCgoZXZlbnQpID0+IHtcbiAgICAgICAgICAoZXZlbnQuY29tbWVudHMgPT09IG51bGwpID8gZXZlbnQuY29tbWVudHMgPSAwIDogZXZlbnQuY29tbWVudHM7XG4gICAgICAgICAgKGV2ZW50LmxlYXZlcyA9PT0gbnVsbCkgPyBldmVudC5sZWF2ZXMgPSAwIDogZXZlbnQubGVhdmVzO1xuICAgICAgICAgIChldmVudC5oaWdoZml2ZXMgPT09IG51bGwpID8gZXZlbnQuaGlnaGZpdmVzID0gMCA6IGV2ZW50LmhpZ2hmaXZlcztcbiAgICAgICAgICAoZXZlbnQuZW50ZXJzID09PSBudWxsKSA/IGV2ZW50LmVudGVycyA9IDAgOiBldmVudC5lbnRlcnM7XG4gICAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgICB9KVxuICAgICAgICAucmVkdWNlKChyZXN1bHQsIHZhbHVlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiZGF0ZVwiOiByZXN1bHQuZGF0ZSxcbiAgICAgICAgICAgIFwiY29tbWVudHNcIjogcGFyc2VJbnQodmFsdWUuY29tbWVudHMsIDEwKSArIHBhcnNlSW50KHJlc3VsdC5jb21tZW50cywgMTApLFxuICAgICAgICAgICAgXCJsZWF2ZXNcIjogcGFyc2VJbnQodmFsdWUubGVhdmVzKSArIHBhcnNlSW50KHJlc3VsdC5sZWF2ZXMpLFxuICAgICAgICAgICAgXCJoaWdoZml2ZXNcIjogcGFyc2VJbnQodmFsdWUuaGlnaGZpdmVzLCAxMCkgKyBwYXJzZUludChyZXN1bHQuaGlnaGZpdmVzLCAxMCksXG4gICAgICAgICAgICBcImVudGVyc1wiOiBwYXJzZUludCh2YWx1ZS5lbnRlcnMsIDEwKSArIHBhcnNlSW50KHJlc3VsdC5lbnRlcnMsIDEwKVxuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICAgIC52YWx1ZSgpO1xuXG4gICAgICByZXN1bHRzLmV2ZW50cy5wdXNoKHRyYW5zZm9ybWVkRXZlbnRzKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHJlc3VsdHMpO1xuICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxuXG4gIGNsZWFyKHJlcSwgcmVzKSB7XG4gICAgcmV0dXJuIEV2ZW50XG4gICAgICAuZGVzdHJveSh7XG4gICAgICAgIHdoZXJlOiB7fSxcbiAgICAgICAgdHJ1bmNhdGU6IHRydWVcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiByZXMuc3RhdHVzKDIwMCkuanNvbih7c3RhdHVzOiBcIm9rXCJ9KSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHJlcy5zdGF0dXMoNDAwKS5zZW5kKGVycm9yKSk7XG4gIH0sXG59O1xuIl19