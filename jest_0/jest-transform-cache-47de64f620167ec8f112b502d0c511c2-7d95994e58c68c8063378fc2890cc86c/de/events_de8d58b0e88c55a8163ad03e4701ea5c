42e04b37de76f4d1bb3f747ec3816c7d
/* eslint-disable no-irregular-whitespace */
const Event = require('../models').event;

const Sequelize = require('sequelize');

let db = require('../models/index');

const Op = Sequelize.Op;

const _ = require('lodash');

const rawSQLQueury = `select date_trunc('hour', "date") as "date", \
case when type = 'comment' then count(type) end as "comments", \
case when type = 'leave' then count(type) end as "leaves", \
case when type = 'highfive' then count(type) end as "highfives", \
case when type = 'enter' then count(type) end as "enters" \
from \
public.events \
where \
type is not null \
and "date" > date_trunc(?, \
timestamp ?) \
and "date" < date_trunc(?, \
timestamp ?) \
group by "date", "type";`;
module.exports = {
  create(req, res) {
    const {
      user,
      type,
      message = null,
      otheruser = null,
      date
    } = req.body;
    return Event.create({
      user,
      type,
      message,
      otheruser,
      date
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  },

  list(req, res) {
    return Event.findAll({
      where: {
        date: {
          [Op.lt]: req.query.to,
          [Op.gt]: req.query.from
        }
      }
    }).then(results => {
      const response = {
        events: []
      };

      const transformedResults = _.map(results, result => {
        const filteredEvent = {};
        filteredEvent.id = result.id;
        filteredEvent.date = result.date;
        filteredEvent.user = result.user;
        filteredEvent.type = result.type;

        if (result.message !== null) {
          filteredEvent.message = result.message;
        }

        if (result.otheruser !== null) {
          filteredEvent.otheruser = result.otheruser;
        }

        return filteredEvent;
      });

      response.events = transformedResults;
      res.status(200).json(response);
    }).catch(error => res.status(400).send(error));
  },

  summary(req, res) {
    return db.sequelize.query(rawSQLQueury, {
      replacements: [req.query.by, req.query.from, req.query.by, req.query.to],
      type: db.sequelize.QueryTypes.SELECT
    }).then(events => {
      const results = {
        events: []
      };

      const transformedEvents = _.chain(events).map(event => {
        event.comments === null ? event.comments = 0 : event.comments;
        event.leaves === null ? event.leaves = 0 : event.leaves;
        event.highfives === null ? event.highfives = 0 : event.highfives;
        event.enters === null ? event.enters = 0 : event.enters;
        return event;
      }).reduce((result, value) => {
        return {
          "date": result.date,
          "comments": parseInt(value.comments, 10) + parseInt(result.comments, 10),
          "leaves": parseInt(value.leaves) + parseInt(result.leaves),
          "highfives": parseInt(value.highfives, 10) + parseInt(result.highfives, 10),
          "enters": parseInt(value.enters, 10) + parseInt(result.enters, 10)
        };
      }).value();

      results.events.push(transformedEvents);
      res.status(200).json(results);
    }).catch(error => res.status(400).send(error));
  },

  clear(req, res) {
    return Event.destroy({
      where: {},
      truncate: true
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy5qcyJdLCJuYW1lcyI6WyJFdmVudCIsInJlcXVpcmUiLCJldmVudCIsIlNlcXVlbGl6ZSIsImRiIiwiT3AiLCJfIiwicmF3U1FMUXVldXJ5IiwibW9kdWxlIiwiZXhwb3J0cyIsImNyZWF0ZSIsInJlcSIsInJlcyIsInVzZXIiLCJ0eXBlIiwibWVzc2FnZSIsIm90aGVydXNlciIsImRhdGUiLCJib2R5IiwidGhlbiIsInN0YXR1cyIsImpzb24iLCJjYXRjaCIsImVycm9yIiwic2VuZCIsImxpc3QiLCJmaW5kQWxsIiwid2hlcmUiLCJsdCIsInF1ZXJ5IiwidG8iLCJndCIsImZyb20iLCJyZXN1bHRzIiwicmVzcG9uc2UiLCJldmVudHMiLCJ0cmFuc2Zvcm1lZFJlc3VsdHMiLCJtYXAiLCJyZXN1bHQiLCJmaWx0ZXJlZEV2ZW50IiwiaWQiLCJzdW1tYXJ5Iiwic2VxdWVsaXplIiwicmVwbGFjZW1lbnRzIiwiYnkiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwidHJhbnNmb3JtZWRFdmVudHMiLCJjaGFpbiIsImNvbW1lbnRzIiwibGVhdmVzIiwiaGlnaGZpdmVzIiwiZW50ZXJzIiwicmVkdWNlIiwidmFsdWUiLCJwYXJzZUludCIsInB1c2giLCJjbGVhciIsImRlc3Ryb3kiLCJ0cnVuY2F0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQVAsQ0FBcUJDLEtBQW5DOztBQUNBLE1BQU1DLFNBQVMsR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsSUFBSUcsRUFBRSxHQUFJSCxPQUFPLENBQUMsaUJBQUQsQ0FBakI7O0FBQ0EsTUFBTUksRUFBRSxHQUFHRixTQUFTLENBQUNFLEVBQXJCOztBQUNBLE1BQU1DLENBQUMsR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBRUEsTUFBTU0sWUFBWSxHQUFJOzs7Ozs7Ozs7Ozs7O3lCQUF0QjtBQWVBQyxNQUFNLENBQUNDLE9BQVAsR0FB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LEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQUNELE1BQUFBLE1BQU0sRUFBRTtBQUFULEtBQXJCLENBTFAsRUFNSkUsS0FOSSxDQU1HQyxLQUFELElBQVdYLEdBQUcsQ0FBQ1EsTUFBSixDQUFXLEdBQVgsRUFBZ0JJLElBQWhCLENBQXFCRCxLQUFyQixDQU5iLENBQVA7QUFPRDs7QUFyRmMsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby1pcnJlZ3VsYXItd2hpdGVzcGFjZSAqL1xuY29uc3QgRXZlbnQgPSByZXF1aXJlKCcuLi9tb2RlbHMnKS5ldmVudDtcbmNvbnN0IFNlcXVlbGl6ZSA9IHJlcXVpcmUoJ3NlcXVlbGl6ZScpO1xubGV0IGRiICA9IHJlcXVpcmUoJy4uL21vZGVscy9pbmRleCcpO1xuY29uc3QgT3AgPSBTZXF1ZWxpemUuT3A7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IHJhd1NRTFF1ZXVyeSA9IGBzZWxlY3QgZGF0ZV90cnVuYygnaG91cicsIFwiZGF0ZVwiKSBhcyBcImRhdGVcIiwgXFxcbmNhc2Ugd2hlbiB0eXBlID0gJ2NvbW1lbnQnIHRoZW4gY291bnQodHlwZSkgZW5kIGFzIFwiY29tbWVudHNcIiwgXFxcbmNhc2Ugd2hlbiB0eXBlID0gJ2xlYXZlJyB0aGVuIGNvdW50KHR5cGUpIGVuZCBhcyBcImxlYXZlc1wiLCBcXFxuY2FzZSB3aGVuIHR5cGUgPSAnaGlnaGZpdmUnIHRoZW4gY291bnQodHlwZSkgZW5kIGFzIFwiaGlnaGZpdmVzXCIsIFxcXG5jYXNlIHdoZW4gdHlwZSA9ICdlbnRlcicgdGhlbiBjb3VudCh0eXBlKSBlbmQgYXMgXCJlbnRlcnNcIiBcXFxuZnJvbSBcXFxucHVibGljLmV2ZW50cyBcXFxud2hlcmUgXFxcbnR5cGUgaXMgbm90IG51bGwgXFxcbmFuZCBcImRhdGVcIiA+IGRhdGVfdHJ1bmMoPywgXFxcbnRpbWVzdGFtcCA/KSBcXFxuYW5kIFwiZGF0ZVwiIDwgZGF0ZV90cnVuYyg/LCBcXFxudGltZXN0YW1wID8pIFxcXG5ncm91cCBieSBcImRhdGVcIiwgXCJ0eXBlXCI7YDtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNyZWF0ZShyZXEsIHJlcykge1xuICAgIGNvbnN0IHsgdXNlciwgdHlwZSwgbWVzc2FnZSA9IG51bGwsIG90aGVydXNlciA9IG51bGwsIGRhdGUgfSA9IHJlcS5ib2R5O1xuICAgIHJldHVybiBFdmVudFxuICAgICAgLmNyZWF0ZSh7IHVzZXIsIHR5cGUsIG1lc3NhZ2UsIG90aGVydXNlciwgZGF0ZSB9KVxuICAgICAgLnRoZW4oKCkgPT4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N0YXR1czogXCJva1wifSkpXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxuXG4gIGxpc3QocmVxLCByZXMpIHtcbiAgICByZXR1cm4gRXZlbnRcbiAgICAgIC5maW5kQWxsKHtcbiAgICAgICAgd2hlcmU6IHtcbiAgICAgICAgICBkYXRlOiB7XG4gICAgICAgICAgICBbT3AubHRdOiByZXEucXVlcnkudG8sXG4gICAgICAgICAgICBbT3AuZ3RdOiByZXEucXVlcnkuZnJvbVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgIGV2ZW50czogW11cbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgdHJhbnNmb3JtZWRSZXN1bHRzID0gXy5tYXAocmVzdWx0cywgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbHRlcmVkRXZlbnQgPSB7fTtcbiAgICAgICAgICBmaWx0ZXJlZEV2ZW50LmlkID0gcmVzdWx0LmlkO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQuZGF0ZSA9IHJlc3VsdC5kYXRlO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQudXNlciA9IHJlc3VsdC51c2VyO1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQudHlwZSA9IHJlc3VsdC50eXBlO1xuICAgICAgICAgIGlmIChyZXN1bHQubWVzc2FnZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgZmlsdGVyZWRFdmVudC5tZXNzYWdlID0gcmVzdWx0Lm1lc3NhZ2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQub3RoZXJ1c2VyICE9PSBudWxsKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZEV2ZW50Lm90aGVydXNlciA9IHJlc3VsdC5vdGhlcnVzZXI7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmaWx0ZXJlZEV2ZW50O1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzcG9uc2UuZXZlbnRzID0gdHJhbnNmb3JtZWRSZXN1bHRzO1xuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXNwb25zZSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVzLnN0YXR1cyg0MDApLnNlbmQoZXJyb3IpKTtcbiAgfSxcblxuICBzdW1tYXJ5KHJlcSwgcmVzKSB7XG4gICAgcmV0dXJuIGRiLnNlcXVlbGl6ZS5xdWVyeShyYXdTUUxRdWV1cnksXG4gICAgICB7IHJlcGxhY2VtZW50czogW3JlcS5xdWVyeS5ieSwgcmVxLnF1ZXJ5LmZyb20sIHJlcS5xdWVyeS5ieSwgcmVxLnF1ZXJ5LnRvXSwgdHlwZTogZGIuc2VxdWVsaXplLlF1ZXJ5VHlwZXMuU0VMRUNUIH1cbiAgICApLnRoZW4oKGV2ZW50cykgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0cyA9IHtcbiAgICAgICAgZXZlbnRzOiBbXVxuICAgICAgfTtcblxuICAgICAgY29uc3QgdHJhbnNmb3JtZWRFdmVudHMgPSBfXG4gICAgICAgIC5jaGFpbihldmVudHMpXG4gICAgICAgIC5tYXAoKGV2ZW50KSA9PiB7XG4gICAgICAgICAgKGV2ZW50LmNvbW1lbnRzID09PSBudWxsKSA/IGV2ZW50LmNvbW1lbnRzID0gMCA6IGV2ZW50LmNvbW1lbnRzO1xuICAgICAgICAgIChldmVudC5sZWF2ZXMgPT09IG51bGwpID8gZXZlbnQubGVhdmVzID0gMCA6IGV2ZW50LmxlYXZlcztcbiAgICAgICAgICAoZXZlbnQuaGlnaGZpdmVzID09PSBudWxsKSA/IGV2ZW50LmhpZ2hmaXZlcyA9IDAgOiBldmVudC5oaWdoZml2ZXM7XG4gICAgICAgICAgKGV2ZW50LmVudGVycyA9PT0gbnVsbCkgPyBldmVudC5lbnRlcnMgPSAwIDogZXZlbnQuZW50ZXJzO1xuICAgICAgICAgIHJldHVybiBldmVudDtcbiAgICAgICAgfSlcbiAgICAgICAgLnJlZHVjZSgocmVzdWx0LCB2YWx1ZSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBcImRhdGVcIjogcmVzdWx0LmRhdGUsXG4gICAgICAgICAgICBcImNvbW1lbnRzXCI6IHBhcnNlSW50KHZhbHVlLmNvbW1lbnRzLCAxMCkgKyBwYXJzZUludChyZXN1bHQuY29tbWVudHMsIDEwKSxcbiAgICAgICAgICAgIFwibGVhdmVzXCI6IHBhcnNlSW50KHZhbHVlLmxlYXZlcykgKyBwYXJzZUludChyZXN1bHQubGVhdmVzKSxcbiAgICAgICAgICAgIFwiaGlnaGZpdmVzXCI6IHBhcnNlSW50KHZhbHVlLmhpZ2hmaXZlcywgMTApICsgcGFyc2VJbnQocmVzdWx0LmhpZ2hmaXZlcywgMTApLFxuICAgICAgICAgICAgXCJlbnRlcnNcIjogcGFyc2VJbnQodmFsdWUuZW50ZXJzLCAxMCkgKyBwYXJzZUludChyZXN1bHQuZW50ZXJzLCAxMClcbiAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgICAgICAudmFsdWUoKTtcblxuICAgICAgcmVzdWx0cy5ldmVudHMucHVzaCh0cmFuc2Zvcm1lZEV2ZW50cyk7XG4gICAgICByZXMuc3RhdHVzKDIwMCkuanNvbihyZXN1bHRzKTtcbiAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVzLnN0YXR1cyg0MDApLnNlbmQoZXJyb3IpKTtcbiAgfSxcblxuICBjbGVhcihyZXEsIHJlcykge1xuICAgIHJldHVybiBFdmVudFxuICAgICAgLmRlc3Ryb3koe1xuICAgICAgICB3aGVyZToge30sXG4gICAgICAgIHRydW5jYXRlOiB0cnVlXG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N0YXR1czogXCJva1wifSkpXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxufTtcbiJdfQ==