ce6549c9351f4aefd8e03f8b413b0701
/* eslint-disable no-irregular-whitespace */
const Event = require('../models').event;

const Sequelize = require('sequelize');

let db = require('../models/index');

const Op = Sequelize.Op;

const _ = require('lodash');

const rawSQLQueury = `select date_trunc(?, "date") as "date", \
case when type = 'comment' then count(type) end as "comments", \
case when type = 'leave' then count(type) end as "leaves", \
case when type = 'highfive' then count(type) end as "highfives", \
case when type = 'enter' then count(type) end as "enters" \
from \
public.events \
where \
type is not null \
and "date" > date_trunc(?, \
timestamp ?) \
and "date" < date_trunc(?, \
timestamp ?) \
group by "date", "type";`;
module.exports = {
  create(req, res) {
    const {
      user,
      type,
      message = null,
      otheruser = null,
      date
    } = req.body;
    return Event.create({
      user,
      type,
      message,
      otheruser,
      date
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  },

  list(req, res) {
    return Event.findAll({
      where: {
        date: {
          [Op.lt]: req.query.to,
          [Op.gt]: req.query.from
        }
      }
    }).then(results => {
      const response = {
        events: []
      };

      const transformedResults = _.map(results, result => {
        const filteredEvent = {};
        filteredEvent.id = result.id;
        filteredEvent.date = result.date;
        filteredEvent.user = result.user;
        filteredEvent.type = result.type;

        if (result.message !== null) {
          filteredEvent.message = result.message;
        }

        if (result.otheruser !== null) {
          filteredEvent.otheruser = result.otheruser;
        }

        return filteredEvent;
      });

      response.events = transformedResults;
      res.status(200).json(response);
    }).catch(error => res.status(400).send(error));
  },

  summary(req, res) {
    return db.sequelize.query(rawSQLQueury, {
      replacements: [req.query.by, req.query.by, req.query.from, req.query.by, req.query.to],
      type: db.sequelize.QueryTypes.SELECT
    }).then(events => {
      const results = {
        events: []
      };

      const transformedEvents = _.chain(events).map(event => {
        event.comments === null ? event.comments = 0 : event.comments;
        event.leaves === null ? event.leaves = 0 : event.leaves;
        event.highfives === null ? event.highfives = 0 : event.highfives;
        event.enters === null ? event.enters = 0 : event.enters;
        return event;
      }).reduce((result, value) => {
        return {
          "date": result.date,
          "comments": parseInt(value.comments, 10) + parseInt(result.comments, 10),
          "leaves": parseInt(value.leaves) + parseInt(result.leaves),
          "highfives": parseInt(value.highfives, 10) + parseInt(result.highfives, 10),
          "enters": parseInt(value.enters, 10) + parseInt(result.enters, 10)
        };
      }).value();

      results.events.push(transformedEvents);
      res.status(200).json(results);
    }).catch(error => res.status(400).send(error));
  },

  clear(req, res) {
    return Event.destroy({
      where: {},
      truncate: true
    }).then(() => res.status(200).json({
      status: "ok"
    })).catch(error => res.status(400).send(error));
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy5qcyJdLCJuYW1lcyI6WyJFdmVudCIsInJlcXVpcmUiLCJldmVudCIsIlNlcXVlbGl6ZSIsImRiIiwiT3AiLCJfIiwicmF3U1FMUXVldXJ5IiwibW9kdWxlIiwiZXhwb3J0cyIsImNyZWF0ZSIsInJlcSIsInJlcyIsInVzZXIiLCJ0eXBlIiwibWVzc2FnZSIsIm90aGVydXNlciIsImRhdGUiLCJib2R5IiwidGhlbiIsInN0YXR1cyIsImpzb24iLCJjYXRjaCIsImVycm9yIiwic2VuZCIsImxpc3QiLCJmaW5kQWxsIiwid2hlcmUiLCJsdCIsInF1ZXJ5IiwidG8iLCJndCIsImZyb20iLCJyZXN1bHRzIiwicmVzcG9uc2UiLCJldmVudHMiLCJ0cmFuc2Zvcm1lZFJlc3VsdHMiLCJtYXAiLCJyZXN1bHQiLCJmaWx0ZXJlZEV2ZW50IiwiaWQiLCJzdW1tYXJ5Iiwic2VxdWVsaXplIiwicmVwbGFjZW1lbnRzIiwiYnkiLCJRdWVyeVR5cGVzIiwiU0VMRUNUIiwidHJhbnNmb3JtZWRFdmVudHMiLCJjaGFpbiIsImNvbW1lbnRzIiwibGVhdmVzIiwiaGlnaGZpdmVzIiwiZW50ZXJzIiwicmVkdWNlIiwidmFsdWUiLCJwYXJzZUludCIsInB1c2giLCJjbGVhciIsImRlc3Ryb3kiLCJ0cnVuY2F0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxNQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQVAsQ0FBcUJDLEtBQW5DOztBQUNBLE1BQU1DLFNBQVMsR0FBR0YsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsSUFBSUcsRUFBRSxHQUFJSCxPQUFPLENBQUMsaUJBQUQsQ0FBakI7O0FBQ0EsTUFBTUksRUFBRSxHQUFHRixTQUFTLENBQUNFLEVBQXJCOztBQUNBLE1BQU1DLENBQUMsR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBRUEsTUFBTU0sWUFBWSxHQUFJOzs7Ozs7Ozs7Ozs7O3lCQUF0QjtBQWVBQyxNQUFNLENBQUNDLE9BQVAsR0FB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LElBTEksQ0FLQyxNQUFNUCxHQUFHLENBQUNRLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFDRCxNQUFBQSxNQUFNLEVBQUU7QUFBVCxLQUFyQixDQUxQLEVBTUpFLEtBTkksQ0FNR0MsS0FBRCxJQUFXWCxHQUFHLENBQUNRLE1BQUosQ0FBVyxHQUFYLEVBQWdCSSxJQUFoQixDQUFxQkQsS0FBckIsQ0FOYixDQUFQO0FBT0Q7O0FBckZjLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8taXJyZWd1bGFyLXdoaXRlc3BhY2UgKi9cbmNvbnN0IEV2ZW50ID0gcmVxdWlyZSgnLi4vbW9kZWxzJykuZXZlbnQ7XG5jb25zdCBTZXF1ZWxpemUgPSByZXF1aXJlKCdzZXF1ZWxpemUnKTtcbmxldCBkYiAgPSByZXF1aXJlKCcuLi9tb2RlbHMvaW5kZXgnKTtcbmNvbnN0IE9wID0gU2VxdWVsaXplLk9wO1xuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuXG5jb25zdCByYXdTUUxRdWV1cnkgPSBgc2VsZWN0IGRhdGVfdHJ1bmMoPywgXCJkYXRlXCIpIGFzIFwiZGF0ZVwiLCBcXFxuY2FzZSB3aGVuIHR5cGUgPSAnY29tbWVudCcgdGhlbiBjb3VudCh0eXBlKSBlbmQgYXMgXCJjb21tZW50c1wiLCBcXFxuY2FzZSB3aGVuIHR5cGUgPSAnbGVhdmUnIHRoZW4gY291bnQodHlwZSkgZW5kIGFzIFwibGVhdmVzXCIsIFxcXG5jYXNlIHdoZW4gdHlwZSA9ICdoaWdoZml2ZScgdGhlbiBjb3VudCh0eXBlKSBlbmQgYXMgXCJoaWdoZml2ZXNcIiwgXFxcbmNhc2Ugd2hlbiB0eXBlID0gJ2VudGVyJyB0aGVuIGNvdW50KHR5cGUpIGVuZCBhcyBcImVudGVyc1wiIFxcXG5mcm9tIFxcXG5wdWJsaWMuZXZlbnRzIFxcXG53aGVyZSBcXFxudHlwZSBpcyBub3QgbnVsbCBcXFxuYW5kIFwiZGF0ZVwiID4gZGF0ZV90cnVuYyg/LCBcXFxudGltZXN0YW1wID8pIFxcXG5hbmQgXCJkYXRlXCIgPCBkYXRlX3RydW5jKD8sIFxcXG50aW1lc3RhbXAgPykgXFxcbmdyb3VwIGJ5IFwiZGF0ZVwiLCBcInR5cGVcIjtgO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgY3JlYXRlKHJlcSwgcmVzKSB7XG4gICAgY29uc3QgeyB1c2VyLCB0eXBlLCBtZXNzYWdlID0gbnVsbCwgb3RoZXJ1c2VyID0gbnVsbCwgZGF0ZSB9ID0gcmVxLmJvZHk7XG4gICAgcmV0dXJuIEV2ZW50XG4gICAgICAuY3JlYXRlKHsgdXNlciwgdHlwZSwgbWVzc2FnZSwgb3RoZXJ1c2VyLCBkYXRlIH0pXG4gICAgICAudGhlbigoKSA9PiByZXMuc3RhdHVzKDIwMCkuanNvbih7c3RhdHVzOiBcIm9rXCJ9KSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHJlcy5zdGF0dXMoNDAwKS5zZW5kKGVycm9yKSk7XG4gIH0sXG5cbiAgbGlzdChyZXEsIHJlcykge1xuICAgIHJldHVybiBFdmVudFxuICAgICAgLmZpbmRBbGwoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIGRhdGU6IHtcbiAgICAgICAgICAgIFtPcC5sdF06IHJlcS5xdWVyeS50byxcbiAgICAgICAgICAgIFtPcC5ndF06IHJlcS5xdWVyeS5mcm9tXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICAgICAgZXZlbnRzOiBbXVxuICAgICAgICB9O1xuICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZFJlc3VsdHMgPSBfLm1hcChyZXN1bHRzLCAocmVzdWx0KSA9PiB7XG4gICAgICAgICAgY29uc3QgZmlsdGVyZWRFdmVudCA9IHt9O1xuICAgICAgICAgIGZpbHRlcmVkRXZlbnQuaWQgPSByZXN1bHQuaWQ7XG4gICAgICAgICAgZmlsdGVyZWRFdmVudC5kYXRlID0gcmVzdWx0LmRhdGU7XG4gICAgICAgICAgZmlsdGVyZWRFdmVudC51c2VyID0gcmVzdWx0LnVzZXI7XG4gICAgICAgICAgZmlsdGVyZWRFdmVudC50eXBlID0gcmVzdWx0LnR5cGU7XG4gICAgICAgICAgaWYgKHJlc3VsdC5tZXNzYWdlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZEV2ZW50Lm1lc3NhZ2UgPSByZXN1bHQubWVzc2FnZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdC5vdGhlcnVzZXIgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGZpbHRlcmVkRXZlbnQub3RoZXJ1c2VyID0gcmVzdWx0Lm90aGVydXNlcjtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZpbHRlcmVkRXZlbnQ7XG4gICAgICAgIH0pO1xuICAgICAgICByZXNwb25zZS5ldmVudHMgPSB0cmFuc2Zvcm1lZFJlc3VsdHM7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHJlc3BvbnNlKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiByZXMuc3RhdHVzKDQwMCkuc2VuZChlcnJvcikpO1xuICB9LFxuXG4gIHN1bW1hcnkocmVxLCByZXMpIHtcbiAgICByZXR1cm4gZGIuc2VxdWVsaXplLnF1ZXJ5KHJhd1NRTFF1ZXVyeSxcbiAgICAgIHsgcmVwbGFjZW1lbnRzOiBbcmVxLnF1ZXJ5LmJ5LCByZXEucXVlcnkuYnksIHJlcS5xdWVyeS5mcm9tLCByZXEucXVlcnkuYnksIHJlcS5xdWVyeS50b10sIHR5cGU6IGRiLnNlcXVlbGl6ZS5RdWVyeVR5cGVzLlNFTEVDVCB9XG4gICAgKS50aGVuKChldmVudHMpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSB7XG4gICAgICAgIGV2ZW50czogW11cbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHRyYW5zZm9ybWVkRXZlbnRzID0gX1xuICAgICAgICAuY2hhaW4oZXZlbnRzKVxuICAgICAgICAubWFwKChldmVudCkgPT4ge1xuICAgICAgICAgIChldmVudC5jb21tZW50cyA9PT0gbnVsbCkgPyBldmVudC5jb21tZW50cyA9IDAgOiBldmVudC5jb21tZW50cztcbiAgICAgICAgICAoZXZlbnQubGVhdmVzID09PSBudWxsKSA/IGV2ZW50LmxlYXZlcyA9IDAgOiBldmVudC5sZWF2ZXM7XG4gICAgICAgICAgKGV2ZW50LmhpZ2hmaXZlcyA9PT0gbnVsbCkgPyBldmVudC5oaWdoZml2ZXMgPSAwIDogZXZlbnQuaGlnaGZpdmVzO1xuICAgICAgICAgIChldmVudC5lbnRlcnMgPT09IG51bGwpID8gZXZlbnQuZW50ZXJzID0gMCA6IGV2ZW50LmVudGVycztcbiAgICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgICAgIH0pXG4gICAgICAgIC5yZWR1Y2UoKHJlc3VsdCwgdmFsdWUpID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCJkYXRlXCI6IHJlc3VsdC5kYXRlLFxuICAgICAgICAgICAgXCJjb21tZW50c1wiOiBwYXJzZUludCh2YWx1ZS5jb21tZW50cywgMTApICsgcGFyc2VJbnQocmVzdWx0LmNvbW1lbnRzLCAxMCksXG4gICAgICAgICAgICBcImxlYXZlc1wiOiBwYXJzZUludCh2YWx1ZS5sZWF2ZXMpICsgcGFyc2VJbnQocmVzdWx0LmxlYXZlcyksXG4gICAgICAgICAgICBcImhpZ2hmaXZlc1wiOiBwYXJzZUludCh2YWx1ZS5oaWdoZml2ZXMsIDEwKSArIHBhcnNlSW50KHJlc3VsdC5oaWdoZml2ZXMsIDEwKSxcbiAgICAgICAgICAgIFwiZW50ZXJzXCI6IHBhcnNlSW50KHZhbHVlLmVudGVycywgMTApICsgcGFyc2VJbnQocmVzdWx0LmVudGVycywgMTApXG4gICAgICAgICAgfTtcbiAgICAgICAgfSlcbiAgICAgICAgLnZhbHVlKCk7XG5cbiAgICAgIHJlc3VsdHMuZXZlbnRzLnB1c2godHJhbnNmb3JtZWRFdmVudHMpO1xuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzdWx0cyk7XG4gICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHJlcy5zdGF0dXMoNDAwKS5zZW5kKGVycm9yKSk7XG4gIH0sXG5cbiAgY2xlYXIocmVxLCByZXMpIHtcbiAgICByZXR1cm4gRXZlbnRcbiAgICAgIC5kZXN0cm95KHtcbiAgICAgICAgd2hlcmU6IHt9LFxuICAgICAgICB0cnVuY2F0ZTogdHJ1ZVxuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHJlcy5zdGF0dXMoMjAwKS5qc29uKHtzdGF0dXM6IFwib2tcIn0pKVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVzLnN0YXR1cyg0MDApLnNlbmQoZXJyb3IpKTtcbiAgfSxcbn07XG4iXX0=